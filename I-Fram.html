<!DOCTYPE html>
<html>
<head>
    <title>Signmary Iframe - JWT Auth</title>
    <style>
        body { font-family: Arial; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1000px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #1e293b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .btn { background: #3b82f6; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #2563eb; }
        .btn-success { background: #10b981; }
        .result { background: #f8fafc; padding: 15px; border-radius: 5px; margin-top: 10px; }
        pre { margin: 0; white-space: pre-wrap; }
        .token-display { background: #1e293b; color: #10b981; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin: 5px 0; }
        iframe { width: 100%; height: 500px; border: 1px solid #ccc; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê Signmary Iframe - JWT Authentication</h1>
            <p>Using JWT tokens for iframe authentication</p>
        </div>

        <div class="section">
            <h3>1. Login & Get JWT Token</h3>
            <button class="btn" onclick="loginAndGetToken()">Login & Get Token</button>
            <button class="btn" onclick="testTokenAuth()">Test Token Authentication</button>
            
            <div id="tokenInfo">
                <p>No token stored yet</p>
            </div>
        </div>

        <div class="section">
            <h3>2. Application Iframe</h3>
            <iframe
                id="mainIframe"
                src="https://esign.signmary.com"
                sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
                allow="storage-access; fullscreen"
            ></iframe>
        </div>

        <div class="section">
            <h3>3. Debug Info</h3>
            <button class="btn" onclick="sendTokenToIframe()">Send Token to Iframe</button>
            <button class="btn" onclick="checkIframeAuth()">Check Iframe Auth Status</button>
            <div id="debugResult" class="result">Debug info will appear here...</div>
        </div>
    </div>

    <script>
        // Store JWT tokens
        let jwtTokens = {
            access: null,
            refresh: null,
            user: null
        };

        // Update token display
        function updateTokenDisplay() {
            const display = document.getElementById('tokenInfo');
            if (jwtTokens.access) {
                display.innerHTML = `
                    <div class="token-display">
                        <strong>Access Token:</strong><br>
                        ${jwtTokens.access.substring(0, 50)}...
                    </div>
                    <div class="token-display">
                        <strong>User:</strong> ${jwtTokens.user ? jwtTokens.user.email : 'Unknown'}
                    </div>
                    <p><strong>Token Status:</strong> ‚úÖ Ready to use</p>
                `;
            } else {
                display.innerHTML = '<p>No token stored yet. Click "Login & Get Token" first.</p>';
            }
        }

        // Login and get JWT token
        async function loginAndGetToken() {
            try {
                const response = await fetch('https://esign-admin.signmary.com/api/auth/login/', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'ireg.member18@gmail.com',
                        password: 'Wirel3$s'
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.access) {
                    jwtTokens = {
                        access: data.access,
                        refresh: data.refresh,
                        user: data.user
                    };
                    
                    updateTokenDisplay();
                    
                    document.getElementById('debugResult').innerHTML = `
                        <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                            <h4>‚úÖ Login Successful!</h4>
                            <p>User: ${data.user.email}</p>
                            <p>Token received and stored.</p>
                        </div>
                    `;
                    
                    // Auto-send token to iframe
                    setTimeout(sendTokenToIframe, 1000);
                    
                } else {
                    document.getElementById('debugResult').innerHTML = `
                        <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                            <h4>‚ùå Login Failed</h4>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                }
                
            } catch (error) {
                document.getElementById('debugResult').innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                        <h4>‚ùå Login Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Test token authentication
        async function testTokenAuth() {
            if (!jwtTokens.access) {
                alert('Please login first to get a token');
                return;
            }

            try {
                const response = await fetch('https://esign-admin.signmary.com/api/api/debug-auth/', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtTokens.access}`
                    },
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                document.getElementById('debugResult').innerHTML = `
                    <div style="background: ${data.authenticated ? '#d4edda' : '#f8d7da'}; padding: 15px; border-radius: 5px;">
                        <h4>${data.authenticated ? '‚úÖ Token Auth Working' : '‚ùå Token Auth Failed'}</h4>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('debugResult').innerHTML = `
                    <div style="background: #f8d7da; padding: 15px; border-radius: 5px;">
                        <h4>‚ùå Token Test Error</h4>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Send token to iframe
        function sendTokenToIframe() {
            if (!jwtTokens.access) {
                alert('Please login first to get a token');
                return;
            }

            const iframe = document.getElementById('mainIframe');
            iframe.contentWindow.postMessage({
                type: 'SET_AUTH_TOKEN',
                token: jwtTokens.access,
                user: jwtTokens.user,
                timestamp: new Date().toISOString()
            }, 'https://esign.signmary.com');
            
            document.getElementById('debugResult').innerHTML = `
                <div style="background: #d4edda; padding: 15px; border-radius: 5px;">
                    <h4>‚úÖ Token Sent to Iframe</h4>
                    <p>JWT token has been sent to the iframe application.</p>
                    <p>The iframe should now be able to make authenticated requests.</p>
                </div>
            `;
        }

        // Check iframe auth status
        function checkIframeAuth() {
            const iframe = document.getElementById('mainIframe');
            iframe.contentWindow.postMessage({
                type: 'CHECK_AUTH_STATUS',
                timestamp: new Date().toISOString()
            }, 'https://esign.signmary.com');
        }

        // Listen for messages from iframe
        window.addEventListener('message', (event) => {
            if (event.origin !== 'https://esign.signmary.com') {
                console.log('Ignored message from:', event.origin);
                return;
            }
            
            console.log('Message from iframe:', event.data);
            
            if (event.data.type === 'AUTH_STATUS') {
                document.getElementById('debugResult').innerHTML = `
                    <div style="background: #e2e8f0; padding: 15px; border-radius: 5px;">
                        <h4>Iframe Auth Status</h4>
                        <pre>${JSON.stringify(event.data, null, 2)}</pre>
                    </div>
                `;
            }
            
            if (event.data.type === 'TOKEN_REQUEST') {
                // If iframe requests token, send it automatically
                sendTokenToIframe();
            }
        });

        // Auto-login when page loads
        window.addEventListener('load', () => {
            console.log('Page loaded. Ready for authentication.');
        });

        // Initial display
        updateTokenDisplay();
    </script>
</body>
</html>
